<link rel="import" href="../bower_components/polymer/polymer.html">
<!--
<link rel="import" href="../bower_components/polymer-ajax/polymer-ajax.html">
-->

<polymer-element name="translation-autocomplete" attributes="q languages">
  <template>
    <style>
      ul {
        border: 1px solid gray;
        list-style: none;
        padding: 10px 0 10px 0;
        margin: 0;
        width: 300px;
        z-index: 9999;
        position: absolute;
        background-color: white;
      }
      
      li {
        padding: 5px 0 5px 0;
        cursor: pointer;
      }
      
      li:hover {
        background-color: #CCC;
      }
      
      li.selecting {
        background-color: #CCC;
      }
      #translation {
        width: 400px;
        max-height: 100px;
        overflow: auto;
      }
      [contenteditable="true"] { 
        padding: 10px; 
        outline: 2px dashed #CCC; 
      }
      [contenteditable="true"]:hover { 
        outline: 2px dashed #0090D2; 
      }
    </style> 
    <input id="textInput" type="text" value="{{search}}" on-keyup="{{keyup}}">
    <div id="translation" contentEditable="true" on-keyup="{{keyup}}"></div>
    <template if="{{results.length > 0}}">
      <ul>
        <template repeat="{{result in results}}">
          <li on-click="{{select}}">{{result}}</li>
        </template>
      </ul>
    </template> 
    
  </template>
  
  <script type="text/javascript" language="javascript"
	src="../../../forecat/forecat.nocache.js"></script>
 
  <script>
    var haystack= [];
    var skipSearch = false;
    var keyboardSelect = -1;
    var poly= null;
    var readygwt= false;
    var readypolymer= false;
    var lang= null;
    
    function readycheck () {
    	if (readygwt && readypolymer) {
    		start();
    	}
    }
    
    function init (a) {
    	console.log("En el init de fuera! "+a);
    	readygwt= true;
    	readycheck();
    }
    
    Polymer('translation-autocomplete', {
      // These default values are overridden
      // by the user's attribute values.
      q: "chrome",
      languages: function () {return lang;},
      languagesServiceSuccess_callback: function(languagesOutput) {
    	  console.log("Response from Languages service: ",JSON.stringify(languagesOutput));
    	  // Cuidado con usar this aquí, porque this se refiere a quien llama a la 
    	  // función y no al objeto polímero
    	  console.log("Accedo a this: "+poly.q);
    	  lang= JSON.stringify(languagesOutput);
    	  poly.fire('translationready',languagesOutput);
      },
      languagesServiceFailure_callback: function (s) {
    	  console.error("Error in Languages service: " + s);
      },
      ready: function() {
        this.search= "Teclea"; 
        this.results= [];
        this.$.textInput.focus();
        this.$.translation.textContent= "Type...";
        
        var dataSource = this.querySelector('.data-source');
        if (dataSource == null) {
          console.log("WARNING: expected to find a .data-source <ul> as a child");
          return;
        }
        var elements= dataSource.getElementsByTagName("li");
        for (var i = 0; i < elements.length; i++ ) {
          haystack.push(elements[i].textContent);
        }
        console.log(haystack);
        console.log("Antes");
        //console.log(abece);
        console.log("Antesbis");
        
        console.log("Después");
        
        poly= this;
        readypolymer= true;
        readycheck();
      },
      init: function() {
    	  console.log("Estoy en init!");
      },
      keyup: function(e) {
        var prefix;
        if (e.target.id=="textInput") {
          prefix= this.search; 
          console.log("Tecleando en input");
        }
        else if (e.target.id="translation") {
          prefix= e.target.textContent;
          console.log("Tecleando en div");
        }
        switch (e.keyCode) {
          case 27: // escape
            this.clear();
            break;
          case 38: // up arrow
            this.moveUp();
            break;
          case 40: // down arrow
            this.moveDown();
            break;
          case 13: // enter
            this.select();
            break;
          default: // TO-DO; use change event instead of keyup
            this.performSearch(prefix);
            break;
        }
      },
      select: function() {
        var lis = this.shadowRoot.querySelectorAll('ul li');
        this.search = lis[keyboardSelect].textContent;
        this.$.translation.textContent= lis[keyboardSelect].textContent;
        skipSearch = true;
        this.reset();
      },
      clear: function() {
        this.reset();
        this.search= "";
        skipSearch= true;
      },
      reset: function() {
        keyboardSelect= -1;
        while (this.results.length >0) {
          this.results.pop();
        }
      },
      moveDown: function() {
        // Be careful with compatibility issues with HTML5 classList:
        // see http://stackoverflow.com/a/196038
        var lis = this.shadowRoot.querySelectorAll('ul li');
        if (keyboardSelect >= 0) lis[keyboardSelect].classList.remove('selecting');
        keyboardSelect = ++keyboardSelect == lis.length ? 0 : keyboardSelect;
        lis[keyboardSelect].classList.add('selecting');
      },
      moveUp: function() {
        lis = this.shadowRoot.querySelectorAll('ul li');
        if (keyboardSelect >= 0) lis[keyboardSelect].classList.remove('selecting');
        if (keyboardSelect == -1) keyboardSelect = lis.length;
        keyboardSelect = --keyboardSelect == -1 ? lis.length-1 : keyboardSelect;
        lis[keyboardSelect].classList.add('selecting');
      },
      performSearch: function(prefix) {
        if (skipSearch) {
          skipSearch = false;
          return;
        }
        // Clear results
        while (this.results.length >0) {
          this.results.pop();
        }
        if (prefix.trim()==="") return;
        var lower = prefix.toLowerCase();
        for (var i = 0; i < haystack.length; i++ ) {
          if (haystack[i].toLowerCase().slice(0,lower.length) == lower) {
            this.results.push(haystack[i]);
          }
        }
      }
    });
    
    function start () {
		languagesService_java([{engine:"apertium", key:"0000"}],poly.languagesServiceSuccess_callback,poly.languagesServiceFailure_callback);
    }
    
  </script> 


</polymer-element>


